name: GitHub_SubnetIDs_parsing

on:
  workflow_dispatch:
    inputs:
      SUBNET_IDs_LAMBDA:
        description: SUBNET IDs for Lambda
        type: string
        required: true

      SUBNET_IDs_RDS:
        description: SUBNET IDs for RDS
        type: string
        required: true
      
env:
  SUBNET_ID_LAMBDA: ${{ inputs.SUBNET_IDs_LAMBDA }}
  SUBNET_ID_RDS: ${{ inputs.SUBNET_IDs_RDS }}

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Parse subnet IDs
        id: parse_subnets
        run: |
          echo "SUBNET_LAMBDA=[\\\"$(echo ${{ env.SUBNET_ID_LAMBDA }} | sed 's/,/\\",\\"/g')\\\"]" >> $GITHUB_OUTPUT
          echo "SUBNET_RDS=[\\\"$(echo ${{ env.SUBNET_ID_RDS }} | sed 's/,/\\",\\"/g')\\\"]" >> $GITHUB_OUTPUT
        
      - name: Printing the parsed value for Lambda
        id: parsed-printing-lambda
        run: |
          echo PARSED-SUBNETS=${{ steps.parse_subnets.outputs.SUBNET_LAMBDA }}

      - name: Printing the parsed value for RDS
        id: parsed-printing-rds
        run: |
          echo PARSED-SUBNETS=${{ steps.parse_subnets.outputs.SUBNET_RDS }}

      - name: Configure AWS Credentials for DEV ENV
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "ap-south-1"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.1.0

      - name: Run Checkov action
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          soft_fail: true
          framework: terraform
          download_external_modules: true
          output_format: cli
          github_pat: ${{ secrets.TOKEN_PAT }}
        
      - name: Initialize Terraform
        run: terraform init

      - name: Plan Terraform
        run: | 
          terraform plan -var-file="dev.tfvars" \
          -var="lambda_subnet_ids=${{ steps.parse_subnets.outputs.SUBNET_LAMBDA }}" \
          -var="rds_subnet_ids=${{ steps.parse_subnets.outputs.SUBNET_RDS }}"

